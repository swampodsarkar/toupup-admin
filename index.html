<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - GG Bazar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="admin-login" class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-800 w-full max-w-sm p-8 rounded-lg shadow-xl border border-gray-700">
            <h1 class="text-2xl font-bold text-center text-emerald-400 mb-6">Admin Login</h1>
            <form id="admin-login-form">
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="admin-password" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <p id="admin-login-error" class="text-red-500 text-sm text-center mb-4"></p>
                <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden container mx-auto p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-emerald-400">Admin Dashboard</h1>
            <button id="admin-logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Logout</button>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-white">Add New Topup Offer</h2>
            <form id="add-offer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="product-id" class="block text-sm text-gray-400">Product ID</label>
                    <select id="product-id" required class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="id_code_topup">ID Code Topup</option>
                        <option value="level_up_pass">LEVEL UP PASS</option>
                        <option value="evo_access">EVO ACCESS</option>
                        <option value="weekly_lite">Weekly Lite</option>
                        <option value="weekly_monthly">Weekly/Monthly Offer</option>
                    </select>
                </div>
                <div id="diamond-field">
                    <label for="diamond-amount" class="block text-sm text-gray-400">Diamond Amount</label>
                    <input type="number" id="diamond-amount" placeholder="e.g., 100" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div id="price-field">
                    <label for="offer-price" class="block text-sm text-gray-400">Price (TK)</label>
                    <input type="number" id="offer-price" placeholder="e.g., 85" required class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div id="world-number-field" class="hidden md:col-span-3">
                    <label for="world-number" class="block text-sm text-gray-400">World Number</label>
                    <input type="text" id="world-number" placeholder="e.g., world-20" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div id="weekly-lite-field" class="hidden">
                    <label for="weekly-lite-amount" class="block text-sm text-gray-400">Weekly Lite Amount</label>
                    <select id="weekly-lite-amount" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="1x">1x</option>
                        <option value="2x">2x</option>
                        <option value="3x">3x</option>
                        <option value="4x">4x</option>
                    </select>
                </div>
                <div id="weekly-monthly-field" class="hidden md:col-span-2 grid grid-cols-2 gap-4">
                    <div>
                        <label for="weekly-amount" class="block text-sm text-gray-400">Weekly Multiplier</label>
                        <select id="weekly-amount" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="1x">1x</option>
                            <option value="2x">2x</option>
                            <option value="3x">3x</option>
                            <option value="4x">4x</option>
                        </select>
                    </div>
                    <div>
                        <label for="monthly-amount" class="block text-sm text-gray-400">Monthly Multiplier</label>
                        <select id="monthly-amount" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="1x">1x</option>
                            <option value="2x">2x</option>
                            <option value="3x">3x</option>
                            <option value="4x">4x</option>
                        </select>
                    </div>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Add Offer</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-white">Current Offers (<span id="current-offers-title">ID Code Topup</span>)</h2>
            <div id="offers-list" class="space-y-3">
                <p>Loading offers...</p>
                </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">Pending Payment Deposits</h2>
            <div id="pending-deposits-list" class="space-y-4">
                <p class="text-gray-400">No pending deposits found.</p>
            </div>
        </div>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref,
            push,
            onValue,
            remove,
            get,
            set,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDtq1vLVZ9D3CBis6FFSpt8psERGyTG6YM",
            authDomain: "gen-z-airdrop.firebaseapp.com",
            databaseURL: "https://gen-z-airdrop-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gen-z-airdrop",
            storageBucket: "gen-z-airdrop.firebasestorage.app",
            messagingSenderId: "1056087088959",
            appId: "1:1056087088959:web:2d15418429c2f378f2bd8a",
            measurementId: "G-CKB3HP9D31"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        const adminLoginSection = document.getElementById('admin-login');
        const adminDashboardSection = document.getElementById('admin-dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');

        const addOfferForm = document.getElementById('add-offer-form');
        const offersListContainer = document.getElementById('offers-list');
        const productIdSelect = document.getElementById('product-id');
        const currentOffersTitle = document.getElementById('current-offers-title');
        
        const diamondField = document.getElementById('diamond-field');
        const diamondInput = document.getElementById('diamond-amount');
        const worldNumberField = document.getElementById('world-number-field');
        const worldNumberInput = document.getElementById('world-number');
        const weeklyLiteField = document.getElementById('weekly-lite-field');
        const weeklyLiteInput = document.getElementById('weekly-lite-amount');
        const weeklyMonthlyField = document.getElementById('weekly-monthly-field');
        const weeklyAmountInput = document.getElementById('weekly-amount');
        const monthlyAmountInput = document.getElementById('monthly-amount');

        // NEW ELEMENT REFERENCES
        const pendingDepositsListContainer = document.getElementById('pending-deposits-list');

        const ADMIN_PASSWORD = "admin123";
        let currentOffersRef;
        let pendingDepositsRef;

        // Admin Authentication
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = adminLoginForm['admin-password'].value;
            if (password === ADMIN_PASSWORD) {
                try {
                    await signInAnonymously(auth);
                    sessionStorage.setItem('isAdminAuthenticated', 'true');
                    showDashboard();
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    adminLoginError.textContent = "Firebase authentication failed.";
                }
            } else {
                adminLoginError.textContent = "Incorrect password.";
            }
        });
        
        adminLogoutBtn.addEventListener('click', async () => {
             await signOut(auth);
             sessionStorage.removeItem('isAdminAuthenticated');
             showLogin();
        });

        function showDashboard() {
            adminLoginSection.classList.add('hidden');
            adminDashboardSection.classList.remove('hidden');
            listenForOffers();
            listenForPendingDeposits(); 
        }

        function showLogin() {
             adminLoginSection.classList.remove('hidden');
             adminDashboardSection.classList.add('hidden');
        }

        // Check auth status on page load
        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
            showDashboard();
        }

        // Add event listener for product selection change
        productIdSelect.addEventListener('change', () => {
            const selectedProductId = productIdSelect.value;
            // Hide all special fields first
            diamondField.classList.add('hidden');
            diamondInput.removeAttribute('required');
            worldNumberField.classList.add('hidden');
            weeklyLiteField.classList.add('hidden');
            weeklyMonthlyField.classList.add('hidden');
            
            // Show fields based on selection
            if (selectedProductId === 'id_code_topup') {
                diamondField.classList.remove('hidden');
                diamondInput.setAttribute('required', '');
            } else if (selectedProductId === 'level_up_pass' || selectedProductId === 'evo_access') {
                worldNumberField.classList.remove('hidden');
            } else if (selectedProductId === 'weekly_lite') {
                weeklyLiteField.classList.remove('hidden');
            } else if (selectedProductId === 'weekly_monthly') {
                weeklyMonthlyField.classList.remove('hidden');
            }

            // Update the title and re-fetch offers for the new product
            currentOffersTitle.textContent = productIdSelect.options[productIdSelect.selectedIndex].text;
            listenForOffers();
        });


        // Add Offer
        addOfferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = productIdSelect.value;
            const price = parseInt(addOfferForm['offer-price'].value);

            if (isNaN(price)) {
                alert("Please fill the price field correctly.");
                return;
            }

            let offerData = { price: price };

            if (productId === 'id_code_topup') {
                const diamonds = parseInt(addOfferForm['diamond-amount'].value);
                if (isNaN(diamonds)) {
                    alert("Please fill the diamond amount field correctly.");
                    return;
                }
                offerData.diamonds = diamonds;
            } else if (productId === 'level_up_pass' || productId === 'evo_access') {
                const worldNumber = addOfferForm['world-number'].value;
                if (!worldNumber) {
                    alert("Please enter the World Number.");
                    return;
                }
                offerData.world_number = worldNumber;
            } else if (productId === 'weekly_lite') {
                const weeklyLiteAmount = addOfferForm['weekly-lite-amount'].value;
                if (!weeklyLiteAmount) {
                    alert("Please select a Weekly Lite amount.");
                    return;
                }
                offerData.amount = weeklyLiteAmount;
            } else if (productId === 'weekly_monthly') {
                const weeklyAmount = addOfferForm['weekly-amount'].value;
                const monthlyAmount = addOfferForm['monthly-amount'].value;
                if (!weeklyAmount || !monthlyAmount) {
                    alert("Please select both Weekly and Monthly amounts.");
                    return;
                }
                offerData.weekly_amount = weeklyAmount;
                offerData.monthly_amount = monthlyAmount;
            }

            if (!auth.currentUser) {
                alert("Not authenticated. Please log in again.");
                showLogin();
                return;
            }

            try {
                const offersRef = ref(database, 'products/' + productId + '/offers');
                await push(offersRef, offerData);
                addOfferForm.reset();
                // Reset to default state
                productIdSelect.value = 'id_code_topup';
                currentOffersTitle.textContent = 'ID Code Topup';
                // Show default fields
                diamondField.classList.remove('hidden');
                diamondInput.setAttribute('required', '');
                worldNumberField.classList.add('hidden');
                weeklyLiteField.classList.add('hidden');
                weeklyMonthlyField.classList.add('hidden');
            } catch (error) {
                console.error("Error adding offer: ", error);
                alert("Failed to add offer. Check console for details.");
            }
        });

        // Listen for and Display Offers in Realtime
        function listenForOffers() {
            const productId = productIdSelect.value;
            // Detach previous listener if it exists
            if (currentOffersRef) {
                onValue(currentOffersRef, () => {}); // Detach listener
            }

            currentOffersRef = ref(database, 'products/' + productId + '/offers');

            onValue(currentOffersRef, (snapshot) => {
                const offers = snapshot.val();
                if (!offers) {
                    offersListContainer.innerHTML = '<p>No offers found.</p>';
                    return;
                }

                let offersArray = Object.keys(offers).map(key => ({
                    id: key,
                    ...offers[key]
                }));

                // Sort offers
                if (productId === 'id_code_topup') {
                    offersArray.sort((a, b) => a.diamonds - b.diamonds);
                } else {
                    offersArray.sort((a, b) => a.price - b.price);
                }

                let offersHTML = '';
                offersArray.forEach((offer) => {
                    let displayInfo = `<span class="text-emerald-400">${offer.price} TK</span>`;
                    
                    if (productId === 'id_code_topup') {
                        displayInfo = `<span class="font-semibold">${offer.diamonds} Diamonds</span> - ${displayInfo}`;
                    } else if (productId === 'level_up_pass' || productId === 'evo_access') {
                        displayInfo = `<span class="font-semibold">World Number: ${offer.world_number}</span> - ${displayInfo}`;
                    } else if (productId === 'weekly_lite') {
                        displayInfo = `<span class="font-semibold">Weekly Lite ${offer.amount}</span> - ${displayInfo}`;
                    } else if (productId === 'weekly_monthly') {
                         displayInfo = `<span class="font-semibold">Weekly: ${offer.weekly_amount}, Monthly: ${offer.monthly_amount}</span> - ${displayInfo}`;
                    }

                    offersHTML += `
                        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-md">
                            <div>
                                ${displayInfo}
                            </div>
                            <button data-id="${offer.id}" class="delete-offer-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>
                        </div>
                    `;
                });
                offersListContainer.innerHTML = offersHTML;
            }, (error) => {
                 console.error("Error listening for offers:", error);
                 offersListContainer.innerHTML = '<p class="text-red-500">Error fetching offers.</p>';
            });
        }
        
        // Delete Offer
        offersListContainer.addEventListener('click', async (e) => {
             if (e.target.classList.contains('delete-offer-btn')) {
                 const offerId = e.target.dataset.id;
                 const productId = productIdSelect.value;
                 
                 if (!auth.currentUser) {
                    alert("Not authenticated. Please log in again.");
                    showLogin();
                    return;
                 }

                 if (confirm("Are you sure you want to delete this offer?")) {
                     try {
                         const offerRef = ref(database, 'products/' + productId + '/offers/' + offerId);
                         await remove(offerRef);
                     } catch (error) {
                         console.error("Error removing offer: ", error);
                         alert("Failed to delete offer.");
                     }
                 }
             }
        });

        // NEW: LISTEN FOR AND DISPLAY PENDING DEPOSITS
        function listenForPendingDeposits() {
            if (pendingDepositsRef) {
                onValue(pendingDepositsRef, () => {}); // Detach listener
            }

            pendingDepositsRef = ref(database, 'add_money_requests');

            onValue(pendingDepositsRef, (snapshot) => {
                const deposits = snapshot.val();
                if (!deposits) {
                    pendingDepositsListContainer.innerHTML = '<p class="text-gray-400">No pending deposits found.</p>';
                    return;
                }

                let depositsArray = Object.keys(deposits).map(key => ({
                    id: key,
                    ...deposits[key]
                })).filter(deposit => deposit.status === 'pending');

                if (depositsArray.length === 0) {
                     pendingDepositsListContainer.innerHTML = '<p class="text-gray-400">No pending deposits found.</p>';
                     return;
                }

                let depositsHTML = '';
                depositsArray.forEach((deposit) => {
                    // Convert the timestamp to a readable format
                    const timestamp = deposit.timestamp ? new Date(deposit.timestamp).toLocaleString() : 'N/A';

                    depositsHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg border border-gray-600 space-y-2">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-white">Deposit Request</h3>
                                <span class="text-xs text-gray-400">ID: ${deposit.id}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <p class="text-gray-400">User ID:</p>
                                    <p class="font-medium text-emerald-400 truncate" title="${deposit.userId}">${deposit.userId}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Amount:</p>
                                    <p class="font-medium text-white">${deposit.amount} TK</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Transaction ID:</p>
                                    <p class="font-medium text-white">${deposit.transactionId}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Method:</p>
                                    <p class="font-medium text-white">${deposit.paymentMethod}</p>
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button data-id="${deposit.id}" data-user-id="${deposit.userId}" data-amount="${deposit.amount}" class="accept-deposit-btn flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Accept</button>
                                <button data-id="${deposit.id}" class="reject-deposit-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Reject</button>
                            </div>
                        </div>
                    `;
                });
                pendingDepositsListContainer.innerHTML = depositsHTML;
            }, (error) => {
                console.error("Error listening for pending deposits:", error);
                pendingDepositsListContainer.innerHTML = '<p class="text-red-500">Error fetching deposits.</p>';
            });
        }
        
        // NEW: HANDLE ACCEPT/REJECT ACTIONS
        pendingDepositsListContainer.addEventListener('click', async (e) => {
            const authUser = auth.currentUser;
            if (!authUser) {
                alert("Not authenticated. Please log in again.");
                showLogin();
                return;
            }

            if (e.target.classList.contains('accept-deposit-btn')) {
                const depositId = e.target.dataset.id;
                const userId = e.target.dataset.userId;
                const amount = parseFloat(e.target.dataset.amount);

                if (confirm("Are you sure you want to accept this deposit?")) {
                    try {
                        const depositRef = ref(database, 'add_money_requests/' + depositId);
                        const userBalanceRef = ref(database, 'users/' + userId + '/balance');

                        // Atomically update user balance
                        const userSnapshot = await get(userBalanceRef);
                        const currentBalance = userSnapshot.exists() ? userSnapshot.val() : 0;
                        const newBalance = currentBalance + amount;
                        await set(userBalanceRef, newBalance);

                        // Update the status of the request
                        await set(ref(database, 'add_money_requests/' + depositId + '/status'), 'accepted');
                        await set(ref(database, 'add_money_requests/' + depositId + '/acceptedAt'), serverTimestamp());
                        
                        alert("Deposit accepted and user balance updated.");
                    } catch (error) {
                        console.error("Error accepting deposit: ", error);
                        alert("Failed to accept deposit. Check console for details.");
                    }
                }
            } else if (e.target.classList.contains('reject-deposit-btn')) {
                const depositId = e.target.dataset.id;
                if (confirm("Are you sure you want to reject this deposit?")) {
                    try {
                        await set(ref(database, 'add_money_requests/' + depositId + '/status'), 'rejected');
                        await set(ref(database, 'add_money_requests/' + depositId + '/rejectedAt'), serverTimestamp());
                        alert("Deposit rejected.");
                    } catch (error) {
                        console.error("Error rejecting deposit: ", error);
                        alert("Failed to reject deposit.");
                    }
                }
            }
        });
    </script>
</body>
</html>
